# AtCoder Heuristic Contenst Tools

Copyright (c) 2023 toast-uz  
Released under the MIT license  
https://opensource.org/licenses/mit-license.php

AtCoderヒューリスティックコンテストの、ローカルテストをサポートするツールです。

## 特徴

前作 [【競プロ】テスト10倍速！AtCoder AHC向け【Python】自動テスト並列処理ツール](https://qiita.com/toast-uz/items/b798cd24d3805aef2d80) の以下の特徴を継承しています。

- ローカルテストための初期環境整備（`steup.py`として独立）
- テスト対象プログラムの更新を検知して自動再コンパイル
- 簡単なコマンドラインオプションによる動作制御（条件によっては、一部、ソース修正が必要）
- 大量のテストを素早く完了できる並列処理

今作では、さらに、以下の特徴を追加しています。

- 初期環境整備を`setup.py`として別プログラム化し、本体をシンプルに
- 初期環境整備で`.gitignore`や`rust-toolchain`も作成
- インタラクティブ型、非インタラクティブ型を自動切り替え
- コンパイル後にダミー実行するようにして、コンパイル直後の実行が遅いことを防止
- Pythonの並列処理ライブラリ`ray`を利用することで並列処理を安定化
- エラーやTLEでテスト対象プログラムが落ちた時、プロセスが暴走することがあったバグを解消
- テストケースの特徴量によるスコア差がわかりやすくなるように、特徴量をスコアとあわせて表示
- 相対スコアゲーに効果ある $Σ\log(1+score)$ 評価を追加
- Optunaに対応、ストレージ、enqueue_trial、枝刈りにも対応
- https://img.atcoder.jp/ahc_standings/ （以下、ahc-standingsと呼びます）のローカル実行に対応

## 使い方

### 1. 準備

適切な`Python3.11`と`Rust1.70.0`の実行環境を、準備しておきます。

ディレクトリ構造は、`cargo_comete`で作成されるものを前提としており、以下に例示します。この通りでなくても、ソースを修正することで対応可能です。

コンテストルートに、`setup.py`と`eval.py`をコピーするとともに、ローカルテストツールをダウンロード、解凍して配置してください。

```
ParentDir
├── ahc028
├── ahc029 （コンテストルート（例））
│   ├── setup.py （コピーする）
│   ├── eval.py  （コピーする）
│   ├── src
│   │   └── bin
│   │       └── a.rs （Rustの提出ソース）
│   └── tools （ローカルテストツール）
│       ├── src
│       │   └── テストツールのソース群
│       └── in
│           └── テストケース入力ファイル群
└── target
    ├── debug
    └── release
        └── Rustの実行ファイル群 
```

### 2. `setup.py`の実行

`python setup.py` を実行します。

- 以下のファイル・ディレクトリを作成してくれます。

```
./.gitignore
./rust-toolchain
tools/out
``````

- 自動でhttps://img.atcoder.jp/ahc_standings/ から `index.html`をダウンロードして`tools/out`に配置してくれます。

- 運営から提供されたローカルテストツールを、自動でコンパイルしてくれます。

### 3. 提出プログラムの作成

提出プログラムを作成します。（これは解説できませんww）

### 4. `eval.py`の修正

`eval.py`のソース冒頭にある以下を、条件にあわせて変更します。なお、`FEATURES`は、変更しなくても一部表示が正しくなくなるだけで、動作はします。

```
# 条件にあわせて以下のみ変更する
LANGUAGE = 'Rust'  # 'Python' or 'Rust'
FEATURES = ['N', 'M', 'K']  # 特徴量
```

### 5. `eval.py`を利用したAHCの最適化例

代表的な最適化例を記載します。オプションパラメータの詳細は`--help`オプションで出るヘルプを参照ください。

#### 最適化例A. 提出プログラムの動作確認

以下にて、単一のテストを実行してデバッグ出力を確認することができます。

`python eval.py -s 0 --visible`

提出プログラムがバグ無く実行完了して、予定した動作ができているか、実行時間は適切か、など細かく確認したい場合に使います。予め、提出プログラムに、デバッグ出力を入れておきます。

なお、以下で複数テストケースを実行し、得点や実行時間の変化を見ることで、さまざまなテストケースにおいて、期待通りの動作をしているかを、確認することが可能です。

`python eval.py -s 0 49`

動作が変なテストケースにしぼって、単一テストでデバッグ付きの実行をすることで、詳細確認します。

#### 最適化例B. 提出プログラムの処理変更時の効果確認

処理前と処理後で、以下にて、テスト0-49を実行します（テストケースは場合によって増やします）。

`python eval.py -s 0 49`

スコア合計や、logスコア合計について、プログラム処理変更前後の差異を確認し、プログラムの改善度合いを確認します。

さらに、ahc-standingsによって、ダッシュボードを使って、試行全体の分析をすることが可能です。以下のコマンドでahc-standingsをローカルサーバとして起動できます。

`python -m http.server --directory tools/out 8000`

起動後に、以下のURLで確認が可能です。`contes=0_49`は実行したケースにあわせて修正します。

http://127.0.0.1:8000/index.html?contest=0_49


#### 最適化例C. ハイパーパラメータの最適化

以下にて、テスト0-999の実行を1試行として、Optunaで1000回試行してハイパーパラメータを最適化することができます。

事前に、ソースの以下の箇所を修正して、Optunaで最適化するハイパーパラメータをセットします。ハイパーパラメータは環境変数として実行プログラムに流し込まれますので、予め、実行プログラム側で環境変数を読み取って、ハイパーパラメータをセットするように作り込んでおく必要があります。

```
# 環境変数で流し込むパラメータ
# int: suugest_intの係数、float: suggest_floatの係数
# enque: enque_trialの値（複数あれば複数回実行）
PARAMS = {
    'AHC_PARAMS_SAMPLE1': {'int': [0, 1000], 'enque': [500]},
    'AHC_PARAMS_SAMPLE2': {'float': [0.0, 1.0], 'enque': [0.5]},
}
```

+ 'int'キーの後ろの値は、`sugggest_int`のパラメータになります。最初の2つが最小値と最大値です。
+ 'float'キーの後ろの値は、`sugggest_float`のパラメータになります。最初の2つが最小値と最大値です。
+ 'enque'キーの後ろの値は、`enque_trial`のパラメータになります。複数ある場合は、`enque_trial`が複数回実行されます。

> `enque_trial`とは、Optunaの試行において、固定値をセットするメソッドです。過去の最適値をセットすることで、新たな試行において最適値の周辺の探索機会が増え、さらなる最適値を見つけやすくなります。


実行は以下にようにして、`-o`オプションにOptunaの試行回数を設定します。

`python eval.py -s 0 999 -o 1000`

実行にあたっては、自動的に枝刈り(prune)を行い、無駄な探索はしないように設定しています。

> pruneとは、大量のテストケースセットで試行する場合に、試行途中で非常に悪い成績のものは途中で試行を中止することで、より短時間に効率的な試行を行う機能です。

試行全体の結果は、Optunaストレージに保存されていますので、optuna-dashboardによって分析することが可能です。以下のコマンドでoptuna-dashboardが起動します。

`optuna-dashboard sqlite:///tools/out/optuna.db`
